<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Kegiatan - Bakti Maba</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .jadwal-card {
            transition: all 0.3s ease;
        }
        .jadwal-card:hover {
            transform: translateY(-2px);
        }
        .filter-mobile {
            display: none;
        }
        @media (max-width: 768px) {
            .filter-desktop {
                display: none;
            }
            .filter-mobile {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <h1 class="text-3xl font-bold text-slate-800">Jadwal Kegiatan</h1>
                <div class="flex space-x-4">
                    <button onclick="exportCalendar()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg flex items-center space-x-2 text-sm">
                        <i class="fas fa-download"></i>
                        <span class="hidden sm:inline">Export Kalender</span>
                        <span class="sm:hidden">Export</span>
                    </button>
                    <button onclick="toggleMobileFilter()" class="bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg flex items-center space-x-2 text-sm sm:hidden">
                        <i class="fas fa-filter" id="filterIcon"></i>
                        <span>Filter</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="container mx-auto px-4 py-6">
            <!-- Desktop Filter Panel -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6 hidden sm:block">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-filter mr-2 text-blue-600"></i>
                    Filter Jadwal
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ Tanggal</label>
                        <input type="date" id="filterTanggal" value="<%= filters.tanggal || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üìç Lokasi</label>
                        <select id="filterLokasi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Lokasi</option>
                            <% lokasiList.forEach(function(lok) { %>
                                <option value="<%= lok.id_lokasi %>" <%= filters.lokasi == lok.id_lokasi ? 'selected' : '' %>><%= lok.nama_lokasi %></option>
                            <% }); %>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üë• Kelompok/Jurusan</label>
                        <select id="filterKelompok" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Kelompok</option>
                            <% kelompokList.forEach(function(kel) { %>
                                <option value="<%= kel.id_kelompok %>" <%= filters.kelompok == kel.id_kelompok ? 'selected' : '' %>><%= kel.nama_kelompok %></option>
                            <% }); %>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex flex-wrap gap-2">
                    <button onclick="applyFilter()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center">
                        <i class="fas fa-filter mr-2"></i>Terapkan Filter
                    </button>
                    <button onclick="clearFilter()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md flex items-center">
                        <i class="fas fa-times mr-2"></i>Reset
                    </button>
                </div>
            </div>

            <!-- Mobile Filter Panel -->
            <div id="mobileFilterPanel" class="filter-mobile bg-white rounded-lg shadow-md p-4 mb-6 hidden">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ Tanggal</label>
                        <input type="date" id="mobileFilterTanggal" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üìç Lokasi</label>
                        <select id="mobileFilterLokasi" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Semua Lokasi</option>
                            <% lokasiList.forEach(function(lok) { %>
                                <option value="<%= lok.id_lokasi %>"><%= lok.nama_lokasi %></option>
                            <% }); %>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üë• Kelompok/Jurusan</label>
                        <select id="mobileFilterKelompok" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Semua Kelompok</option>
                            <% kelompokList.forEach(function(kel) { %>
                                <option value="<%= kel.id_kelompok %>"><%= kel.nama_kelompok %></option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="applyMobileFilter()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                            Terapkan
                        </button>
                        <button onclick="clearMobileFilter()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">
                            Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Jadwal List -->
            <div id="jadwalContainer" class="space-y-4">
                <% jadwal.forEach(function(item) { %>
                    <div class="jadwal-card bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow">
                        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start space-y-4 lg:space-y-0">
                            <div class="flex-1">
                                <!-- Header -->
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3">
                                    <div class="flex items-start space-x-3 mb-2 sm:mb-0">
                                        <h3 class="text-lg sm:text-xl font-semibold text-gray-800"><%= item.nama_kegiatan %></h3>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <% if (item.Kelompoks && item.Kelompoks.length > 0) { %>
                                            <% item.Kelompoks.forEach(function(kel) { %>
                                                <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                                                    <%= kel.nama_kelompok %>
                                                </span>
                                            <% }); %>
                                        <% } %>
                                    </div>
                                </div>
                                
                                <!-- Description -->
                                <% if (item.deskripsi) { %>
                                    <p class="text-gray-600 mb-3 text-sm"><%= item.deskripsi %></p>
                                <% } %>
                                
                                <!-- Info Grid -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-calendar text-blue-500 w-4"></i>
                                        <span class="text-gray-700"><%= new Date(item.tanggal).toLocaleDateString('id-ID', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }) %></span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-clock text-green-500 w-4"></i>
                                        <span class="text-gray-700"><%= item.waktu_mulai %></span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-map-marker-alt text-red-500 w-4"></i>
                                        <span class="text-gray-700"><%= item.Lokasi ? item.Lokasi.nama_lokasi : 'Lokasi belum ditentukan' %></span>
                                    </div>
                                </div>
                                
                                <!-- Address -->
                                <% if (item.Lokasi && item.Lokasi.alamat) { %>
                                    <div class="mt-2 text-sm text-gray-500 flex items-start space-x-2">
                                        <i class="fas fa-info-circle mt-0.5"></i>
                                        <span><%= item.Lokasi.alamat %></span>
                                    </div>
                                <% } %>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row gap-2 lg:flex-col">
                                <button data-id="<%= item.id_kegiatan %>" data-nama="<%= item.nama_kegiatan %>" data-tanggal="<%= item.tanggal %>" data-waktu="<%= item.waktu_mulai %>" data-deskripsi="<%= item.deskripsi || '' %>" data-lokasi="<%= item.Lokasi ? item.Lokasi.nama_lokasi : '' %>" onclick="addToCalendarFromData(this)" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-lg flex items-center justify-center" title="Tambah ke Kalender">
                                    <i class="fas fa-calendar-plus"></i>
                                    <span class="ml-2 text-sm hidden sm:inline">Kalender</span>
                                </button>
                                <button data-nama="<%= item.Lokasi ? item.Lokasi.nama_lokasi : '' %>" data-alamat="<%= item.Lokasi ? item.Lokasi.alamat : '' %>" onclick="showLocationFromData(this)" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg flex items-center justify-center" title="Lihat Lokasi">
                                    <i class="fas fa-map"></i>
                                    <span class="ml-2 text-sm hidden sm:inline">Lokasi</span>
                                </button>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
            
            <% if (jadwal.length === 0) { %>
                <div class="text-center py-12">
                    <i class="fas fa-calendar-times text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Tidak ada jadwal kegiatan</h3>
                    <p class="text-gray-500">Belum ada jadwal kegiatan yang dijadwalkan saat ini.</p>
                </div>
            <% } %>
        </div>

        <!-- Notification Modal -->
        <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-semibold mb-4">üîî Notifikasi Jadwal</h3>
                <p class="text-gray-600 mb-4">Dapatkan notifikasi sebelum kegiatan dimulai untuk mengingatkan Anda.</p>
                <div class="flex space-x-2">
                    <button onclick="requestNotificationPermission()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex-1">
                        Aktifkan Notifikasi
                    </button>
                    <button onclick="closeNotificationModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md flex-1">
                        Tutup
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Mobile filter toggle
            function toggleMobileFilter() {
                const panel = document.getElementById('mobileFilterPanel');
                const icon = document.getElementById('filterIcon');
                
                if (panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                } else {
                    panel.classList.add('hidden');
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            }
            
            // Filter functionality
            function applyFilter() {
                const tanggal = document.getElementById('filterTanggal').value;
                const lokasi = document.getElementById('filterLokasi').value;
                const kelompok = document.getElementById('filterKelompok').value;
                
                performFilter(tanggal, lokasi, kelompok);
            }
            
            function applyMobileFilter() {
                const tanggal = document.getElementById('mobileFilterTanggal').value;
                const lokasi = document.getElementById('mobileFilterLokasi').value;
                const kelompok = document.getElementById('mobileFilterKelompok').value;
                
                performFilter(tanggal, lokasi, kelompok);
                toggleMobileFilter(); // Close mobile filter after applying
            }
            
            function performFilter(tanggal, lokasi, kelompok) {
                let url = '/jadwal?';
                if (tanggal) url += `tanggal=${tanggal}&`;
                if (lokasi) url += `lokasi=${lokasi}&`;
                if (kelompok) url += `kelompok=${kelompok}&`;
                
                window.location.href = url;
            }
            
            function clearFilter() {
                document.getElementById('filterTanggal').value = '';
                document.getElementById('filterLokasi').value = '';
                document.getElementById('filterKelompok').value = '';
                location.reload();
            }
            
            function clearMobileFilter() {
                document.getElementById('mobileFilterTanggal').value = '';
                document.getElementById('mobileFilterLokasi').value = '';
                document.getElementById('mobileFilterKelompok').value = '';
                location.reload();
            }
            
            // Calendar export functionality
            function exportCalendar() {
                const kelompok = document.getElementById('filterKelompok').value;
                let url = '/jadwal/api/export';
                if (kelompok) {
                    url += `?kelompok=${kelompok}`;
                }
                
                window.open(url, '_blank');
            }
            
            // Calendar add functionality
            function addToCalendarFromData(button) {
                const id = button.getAttribute('data-id');
                const nama = button.getAttribute('data-nama');
                const tanggal = button.getAttribute('data-tanggal');
                const waktu = button.getAttribute('data-waktu');
                const deskripsi = button.getAttribute('data-deskripsi');
                const lokasi = button.getAttribute('data-lokasi');
                
                addToCalendar(id, nama, tanggal, waktu, deskripsi, lokasi);
            }
            
            function addToCalendar(id, nama, tanggal, waktu, deskripsi, lokasi) {
                const startDate = new Date(`${tanggal}T${waktu}`);
                const endDate = new Date(startDate.getTime() + (2 * 60 * 60 * 1000)); // Default 2 jam
                
                const event = {
                    title: nama,
                    description: deskripsi || '',
                    location: lokasi,
                    start: startDate.toISOString(),
                    end: endDate.toISOString()
                };
                
                // Create calendar URL
                const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(event.title)}&dates=${startDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z/${endDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z&details=${encodeURIComponent(event.description)}&location=${encodeURIComponent(event.location)}`;
                
                window.open(googleUrl, '_blank');
                
                Swal.fire({
                    title: 'Berhasil!',
                    text: 'Jadwal telah ditambahkan ke Google Calendar',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            }
            
            // Location show functionality
            function showLocationFromData(button) {
                const nama = button.getAttribute('data-nama');
                const alamat = button.getAttribute('data-alamat');
                
                showLocation(nama, alamat);
            }
            
            function showLocation(nama, alamat) {
                if (!nama) {
                    Swal.fire('Info', 'Lokasi belum ditentukan', 'info');
                    return;
                }
                
                let content = `<strong>${nama}</strong>`;
                if (alamat) {
                    content += `<br><br>${alamat}`;
                }
                
                Swal.fire({
                    title: 'üìç Lokasi Kegiatan',
                    html: content,
                    icon: 'info',
                    confirmButtonText: 'OK'
                });
            }
            
            // Notification functionality
            function requestNotificationPermission() {
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            Swal.fire('Berhasil!', 'Notifikasi telah diaktifkan', 'success');
                            closeNotificationModal();
                        } else {
                            Swal.fire('Dibatalkan', 'Izin notifikasi ditolak', 'info');
                        }
                    });
                } else {
                    Swal.fire('Tidak Didukung', 'Browser Anda tidak mendukung notifikasi', 'warning');
                }
            }
            
            function closeNotificationModal() {
                document.getElementById('notificationModal').classList.add('hidden');
            }
            
            // Show notification modal on page load (optional)
            // setTimeout(() => {
            //     if (Notification.permission === 'default') {
            //         document.getElementById('notificationModal').classList.remove('hidden');
            //     }
            // }, 3000);
        </script>
    </div>
</body>
</html> 